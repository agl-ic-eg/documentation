<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="Shankho Boron Ghosh">
    <link rel="canonical" href="http://docs.automotivelinux.org/6_How_To_Contribute/A_How_to_setup_your_own_AGL_LAVA_Lab/">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>A How to setup your own AGL LAVA Lab - AGL Documentation</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Prerequisites", url: "#_top", children: [
          ]},
          {title: "Steps to create your own LAVA lab", url: "#steps-to-create-your-own-lava-lab", children: [
          ]},
          {title: "Adding new device-type templates", url: "#adding-new-device-type-templates", children: [
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav">
      <a href="../9_Contribution_Checklist/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../9_Contribution_Checklist/" class="btn btn-xs btn-link">
        Contribution Checklist
      </a>
    </div>
    
  </div>

    

    <h2 id="prerequisites">Prerequisites</h2>
<p>As well as the packages docker, docker-compose and pyyaml mentioned in the top</p>
<p>level README, you will need the following:</p>
<p>1) The following ports are forwarded to docker and therefore need to be kept free</p>
<p>on the host machine:</p>
<ul>
<li>
<p>69/UDP: proxyfied to the slave for TFTP</p>
</li>
<li>
<p>80: proxyfied to the slave for TODO (transfer overlay)</p>
</li>
<li>
<p>5500: proxyfied to the slave for Notification</p>
</li>
<li>
<p>55950-56000: proxyfied to the slave for NBD</p>
</li>
</ul>
<p>2) You will need a remote power switch to remotely power the DUTs on and off.</p>
<p>3) You need to have an account with lava.automotivelinux.org. Please contact the</p>
<p>agl-dev-community mailing list if you would like an account, and include that you would</p>
<p>like to create your own lab in the email so that the relevant user permissions</p>
<p>can be set.</p>
<h2 id="steps-to-create-your-own-lava-lab">Steps to create your own LAVA lab</h2>
<p>1) Clone AGL lava-docker image:</p>
<div class="highlight"><pre><span></span><code>git clone https://git.automotivelinux.org/AGL/lava-docker.git

cd lava-docker
</code></pre></div>
<p>2) On the LAVA master web GUI, create a new API token:</p>
<p>https://lava.automotivelinux.org/api/tokens/</p>
<p>3) Connect all the DUTs' serial to usb and ethernet connections to the host.</p>
<p>4) Edit the boards.yaml file:</p>
<ul>
<li>
<p>Copy the API token you created in step 2 in the place of <generated_lab_token>.</p>
</li>
<li>
<p>Add details of each board connected to the lab. See the top level README for</p>
</li>
</ul>
<p>instructions. You will need the following:</p>
<ul>
<li>
<p>any custom options you require in the kernel args</p>
</li>
<li>
<p>uart idvendor, idproduct, devpath</p>
</li>
<li>
<p>power on, off and reset commads for the power switch</p>
</li>
</ul>
<p>To get the uart idvendor and idproduct, unplug and re-plugin the USB cable of the</p>
<p>device in question and then find the details in the latest output of:</p>
<div class="highlight"><pre><span></span><code>sudo dmesg | grep idvendor
</code></pre></div>
<p>To get the uart devpath, run the command:</p>
<div class="highlight"><pre><span></span><code>udevadm info -a -n /dev/ttyUSB1 |grep devpath | head -n1
</code></pre></div>
<p>NOTE: Make sure you have at least one "board" included. (It is easiest to keep</p>
<p>qemu).</p>
<p>5) Run the automated setup script:</p>
<div class="highlight"><pre><span></span><code>./start.sh slave
</code></pre></div>
<p>7) Check the web GUI to see if the lab has successfully connected to the LAVA</p>
<p>master: https://lava.automotivelinux.org/scheduler/allworkers. If it isn't, run the</p>
<p>following command for debugging:</p>
<div class="highlight"><pre><span></span><code>docker-exec -it &lt;name_of_docker_container&gt; cat /var/log/lava-dispatcher/lava-slave.log
</code></pre></div>
<p>To identify the container name run the following to list the running containers:</p>
<div class="highlight"><pre><span></span><code>docker ps
</code></pre></div>
<p>LAVA logs can be found in <code>/var/log/lava-dispatcher/</code>.</p>
<p>8) Helper scripts</p>
<p>There are a few helper scripts to automate starting/stopping the lab.</p>
<div class="highlight"><pre><span></span><code>./start.sh slave

./restart.sh slave

./stop.sh slave
</code></pre></div>
<h2 id="adding-new-device-type-templates">Adding new device-type templates</h2>
<p>Not all device types are supported by default. Templates for new devices will</p>
<p>need to be added to the LAVA master. Please submit new templates to the agl-dev-community</p>
<p>mailing list.</p>
<p>Before you submit any new device-type templates, please verify that they work.</p>
<p>You can verify that they work in LAVA by carrying out the following instructions:</p>
<p>1) Install lavacli on Debian Stretch or Ubuntu 18.04 and later (if you don't</p>
<p>have a compatible OS, please see https://lava.automotivelinux.org/api/help/ for an</p>
<p>alternative way to use the API)</p>
<p>2) Create your lavacli config file</p>
<div class="highlight"><pre><span></span><code>touch ~/.config/lavacli.yaml
</code></pre></div>
<p>3) Configure this file to look like the following (note: use the first token</p>
<p>created in https://lava.automotivelinux.org/api/tokens/)</p>
<div class="highlight"><pre><span></span><code>default:

uri: https://lava.automotivelinux.org/RPC2

username: &lt;username&gt;

token: &lt;API_token&gt;
</code></pre></div>
<p>4) Add your device template to the master</p>
<div class="highlight"><pre><span></span><code>lavacli device-types template set &lt;device-type-name&gt; &lt;device-type-name&gt;.yaml
</code></pre></div>
<p>NOTE: make sure your device-type templates always follow the following naming scheme:</p>
<p><code>&lt;device-type-name&gt;.yaml</code></p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav">
      <a href="../9_Contribution_Checklist/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../9_Contribution_Checklist/" class="btn btn-xs btn-link">
        Contribution Checklist
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>