<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="Shankho Boron Ghosh">
    <link rel="canonical" href="http://docs.automotivelinux.org/0_Getting_Started/2_Building_AGL_Image/5_4_Virtio/">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Building for virtio - AGL Documentation</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "1. Making Sure Your Build Environment is Correct", url: "#_top", children: [
          ]},
          {title: "2. Using BitBake", url: "#2-using-bitbake", children: [
          ]},
          {title: "3. Deploying the AGL Demo Image", url: "#3-deploying-the-agl-demo-image", children: [
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../3_AGL_Profile/Build%20and%20Boot%20AGL%20Instrument%20Cluster%20demo%20image%20%28IC-IVI%20with%20Container%20isolation%29/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../3_AGL_Profile/Build%20and%20Boot%20AGL%20Instrument%20Cluster%20demo%20image%20%28IC-IVI%20with%20Container%20isolation%29/" class="btn btn-xs btn-link">
        Build and Boot AGL Instrument Cluster demo image (IC-IVI with Container isolation)
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../5_3_RCar_Gen_3/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../5_3_RCar_Gen_3/" class="btn btn-xs btn-link">
        Building for Supported Renesas Boards
      </a>
    </div>
    
  </div>

    

    <p>Virtio is a standartized interface for implementing virtual I/O devices:</p>
<ul>
<li>Russell, Rusty. "virtio: towards a de-facto standard for virtual I/O devices." ACM SIGOPS Operating Systems Review 42.5 (2008): 95-103.</li>
</ul>
<p>This section describes the steps you need to take to build the AGL demo image
for virtio "platform". Later, the same image can be run on various emulators or
hypervisors that provide virtio devices, for example, QEMU aarch64 emulation on
PC, QEMU/KVM aarch64 virtualization on AGL Reference Hardware, etc.</p>
<p>Below, AGL minimal image and Qt based IVI demo are used as example, but
similiarly one can run HTML5 based demos, cluster demo, or other AGL images.</p>
<h2 id="1-making-sure-your-build-environment-is-correct">1. Making Sure Your Build Environment is Correct</h2>
<p>The
"<a href="../3_Initializing_Your_Build_Environment/">Initializing Your Build Environment</a>"
section presented generic information for setting up your build environment
using the <code>aglsetup.sh</code> script.
If you are building the AGL demo image for virtio platform, you need to specify
some specific options when you run the script:</p>
<div class="highlight"><pre><span></span><code>$ <span class="nb">source</span> meta-agl/scripts/aglsetup.sh -m virtio-aarch64 -b build-virtio-aarch64 agl-demo
</code></pre></div>
<p>The "-m" option specifies the "virtio-aarch64" machine.</p>
<p>The "-b" option sets custom build directory instead of default "build".</p>
<p>The "-f" option might be added to override previously available configuration.
By default, if there were already configuration files in build directory, they
will not be overriden, as result, aglsetup.sh might not have desired effect.</p>
<h2 id="2-using-bitbake">2. Using BitBake</h2>
<p>This section shows the <code>bitbake</code> command used to build the AGL image.</p>
<p>Start the build using the <code>bitbake</code> command.</p>
<p><strong>AGL minimal image :</strong>
The target is <code>agl-image-minimal</code>.</p>
<div class="highlight"><pre><span></span><code>$ bitbake agl-image-minimal
</code></pre></div>
<p><strong>Qt Based IVI demo :</strong>
The target is <code>agl-demo-platform</code>.</p>
<div class="highlight"><pre><span></span><code>$ bitbake agl-demo-platform
</code></pre></div>
<h2 id="3-deploying-the-agl-demo-image">3. Deploying the AGL Demo Image</h2>
<p>This subsection describes AGL virtio-aarch64 image deployment under virtio
platform provided by QEMU aarch64 emulator on PC, or QEMU/KVM hypervisor on AGL
Reference Hardware board.</p>
<p><strong>3.1 QEMU on PC</strong></p>
<p>If shell from which AGL was built is closed, or new shell is opened, then it is
needed to re-initialize build environment:</p>
<div class="highlight"><pre><span></span><code>$ <span class="nb">source</span> <span class="nv">$AGL_TOP</span>/build-virtio-aarch64/agl-init-build-env
</code></pre></div>
<p>And further use <code>runqemu</code> to boot the image :</p>
<div class="highlight"><pre><span></span><code>$ runqemu
</code></pre></div>
<p><strong>3.2 QEMU/KVM on AGL Reference Hardware</strong></p>
<p>Follow these steps to run virtual AGL on bare-metal AGL (AGL-in-AGL) on AGL Reference Hardware board:</p>
<ol>
<li>
<p>Partition eMMC or SD-Card to have two partitions, at least 1 GiB each.
    Actually, can be less but just rounded up to have a nice number.</p>
</li>
<li>
<p>Flash AGL minimal image root file system to the second partition on SD-Card
    or eMMC.</p>
</li>
<li>
<p>Build AGL minimal image for AGL Reference Hardware.</p>
<div class="highlight"><pre><span></span><code><span class="nb">source</span> meta-agl/scripts/aglsetup.sh -m h3ulcb -b build-h3ulcb agl-refhw-h3
</code></pre></div>
<p>In <code>build-h3ulcb/conf/local.conf</code> add</p>
<div class="highlight"><pre><span></span><code>AGL_DEFAULT_IMAGE_FSTYPES = &quot;ext4&quot;
IMAGE_INSTALL_append = &quot;qemu&quot;
</code></pre></div>
<p>CAUTION: Calling aglsetup.sh with "-f" flag will remove above modification
in "local.conf", so they will be needed to be re-applied.</p>
<p>Build image:</p>
<div class="highlight"><pre><span></span><code>bitbake agl-image-minimal
</code></pre></div>
<p>Add virtio kernel to the AGL Reference Hardware Linux rootfs:</p>
<div class="highlight"><pre><span></span><code>cp build-virtio-aarch64/tmp/deploy/images/virtio-aarch64/Image build-h3ulcb/tmp/work/h3ulcb-agl-linux/agl-image-minimal/1.0-r0/rootfs/linux2
bitbake agl-image-minimal -c image_ext4 -f
bitbake agl-image-minimal -c image_complete
</code></pre></div>
<p>Flash root file system to the first partition on SD-Card or eMMC.</p>
</li>
<li>
<p>Boot AGL Reference Hardware board using Linux located on the first partition of SD-Card or eMMC.</p>
</li>
<li>
<p>Run QEMU from Linux 1 command line</p>
<div class="highlight"><pre><span></span><code>qemu-system-aarch64 <span class="se">\</span>
  -machine virt <span class="se">\</span>
  -cpu cortex-a57 <span class="se">\</span>
  -m <span class="m">2048</span> <span class="se">\</span>
  -serial mon:stdio <span class="se">\</span>
  -global virtio-mmio.force-legacy<span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
  -drive <span class="nv">id</span><span class="o">=</span>disk0,file<span class="o">=</span>/dev/mmcblk0p2,if<span class="o">=</span>none,format<span class="o">=</span>raw <span class="se">\</span>
  -device virtio-blk-device,drive<span class="o">=</span>disk0 <span class="se">\</span>
  -object rng-random,filename<span class="o">=</span>/dev/urandom,id<span class="o">=</span>rng0 <span class="se">\</span>
  -device virtio-rng-device,rng<span class="o">=</span>rng0 <span class="se">\</span>
  -nographic <span class="se">\</span>
  -kernel /linux2
  -append <span class="s1">&#39;root=/dev/vda rw mem=2048M&#39;</span>
</code></pre></div>
<p>NOTE: mmcblk0p2 above is used for when root file system is flashed on eMMC.
In case of SD-Card, mmcblk1p2 has to be used.</p>
</li>
<li>
<p>It is possible to exit from QEMU using monitor commands. Enter "Ctrl+a h" for help.</p>
</li>
</ol>
<p>Know issue: to enable hardware virtualization using KVM, option <code>-enable-kvm</code>
could be added to QEMU command line, but it fails with:</p>
<div class="highlight"><pre><span></span><code>qemu-system-aarch64: kvm_init_vcpu failed: Invalid argument
</code></pre></div>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../3_AGL_Profile/Build%20and%20Boot%20AGL%20Instrument%20Cluster%20demo%20image%20%28IC-IVI%20with%20Container%20isolation%29/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../3_AGL_Profile/Build%20and%20Boot%20AGL%20Instrument%20Cluster%20demo%20image%20%28IC-IVI%20with%20Container%20isolation%29/" class="btn btn-xs btn-link">
        Build and Boot AGL Instrument Cluster demo image (IC-IVI with Container isolation)
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../5_3_RCar_Gen_3/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../5_3_RCar_Gen_3/" class="btn btn-xs btn-link">
        Building for Supported Renesas Boards
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>